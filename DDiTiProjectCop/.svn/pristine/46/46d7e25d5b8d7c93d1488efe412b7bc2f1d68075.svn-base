<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js" ></script>

<div class="container-full">
<!-- Content Header (Page header) -->
<div class="content-header">
	<div class="d-flex align-items-center">
		<div class="me-auto">
			<!-- 현재 메뉴명 --><h3 class="page-title">상담 </h3>
			<div class="d-inline-block align-items-center">
				<nav>
					<ol class="breadcrumb">
						<!-- 홈아이콘 --><li class="breadcrumb-item"><a href="#"><i class="mdi mdi-home-outline"></i></a></li>
						<!-- 상위메뉴명 --><li class="breadcrumb-item" aria-current="page">메뉴명</li>
						<!-- 하위메뉴명(현재메뉴명) --><li class="breadcrumb-item active" aria-current="page">하위메뉴명(현재메뉴명)</li>
					</ol>
				</nav>
			</div>
		</div>

	</div>
</div>

<section class="content">
		<div class="row">
			<div class="col-lg-9 col-12">
				<div class="row">
					<div class="col-lg-8 col-md-8 col-12">
  						<div class="box bg-lightest">
						  <div class="box-header">
							<div class="media align-items-top p-0">
								<div class="d-lg-flex d-block justify-content-between align-items-center w-p100">
									<div class="media-body mb-lg-0 mb-20">
										<p class="fs-16">
										  <a class="hover-primary" href="#"><strong>상담</strong></a>
										</p>
										  <p class="fs-12"></p>
									</div>
								</div>				  
							</div>             
						  </div>
						  <div class="box-body" style="max-height: 450px; overflow-y: hidden;">
						  <div class="chat-box-one2" id="chatContent">
							  <!-- <div class="card d-inline-block mb-3 float-start me-2 no-shadow bg-lighter max-w-p80">
								<div class="position-absolute pt-1 pe-2 r-0">
									<span class="text-extra-small text-muted">09:25</span>
								</div>
								<div class="card-body">
									<div class="d-flex flex-row pb-2">
										<div class="d-flex flex-grow-1 min-width-zero">
											<div class="m-2 ps-0 align-self-center d-flex flex-column flex-lg-row justify-content-between">
												<div class="min-width-zero">
													<p class="mb-0 fs-16 text-dark">Sarah Kortney</p>
												</div>
											</div>
										</div>
									</div>
									<div class="chat-text-start ps-55">
										<p class="mb-0 text-semi-muted">What do you think about our plans for this product launch?</p>
									</div>
								</div>
							  </div>
							  <div class="clearfix"></div> -->

							<c:if test="${not empty recordList }">
							
								 <c:forEach items="${recordList }" var="record">
									<c:if test="${memNo ne record.memNo }">
										<div class="card d-inline-block mb-3 float-start me-2 no-shadow bg-lighter max-w-p80">
										<div class="position-absolute pt-1 pe-2 r-0">
											<span class="text-extra-small text-muted">${record.chatDate }</span>
												</div>
												<div class="card-body">
													<div class="d-flex flex-row pb-2">
														<div class="d-flex flex-grow-1 min-width-zero">
															<div class="m-2 ps-0 align-self-center d-flex flex-column flex-lg-row justify-content-between">
																<div class="min-width-zero">
																	<p class="mb-0 fs-16 text-dark">${record.chatSender }</p>
																</div>
															</div>
														</div>
													</div>
													<div class="chat-text-start ps-55">
													<p class="mb-0 text-semi-muted">${record.chatMsg }</p>
												</div>
											</div>
										  </div>

									</c:if>
									<c:if test="${memNo eq record.memNo }">
										<div class="card d-inline-block mb-3 float-end me-2 bg-primary max-w-p80">
											<div class="position-absolute pt-1 pe-2 r-0">
												<span class="text-extra-small text-muted">${record.chatDate }</span>
											</div>
											<div class="card-body">
												<div class="d-flex flex-row pb-2">
													<div class="d-flex flex-grow-1 min-width-zero">
														<div class="m-2 ps-0 align-self-center d-flex flex-column flex-lg-row justify-content-between">
															<div class="min-width-zero">
																<p class="mb-0 fs-16 text-dark">${record.chatSender }</p>
															</div>
														</div>
													</div>
												</div>
												<div class="chat-text-start ps-55">
												<p class="mb-0 text-semi-muted">${record.chatMsg }</p>
											</div>
										</div>
									  </div>
									</c:if>
									<div class="clearfix"></div>
									
								</c:forEach>
							</c:if>

						  </div>
					  </div>
					  <div class="box-footer no-border">
						 <div class="d-md-flex d-block justify-content-between align-items-center bg-white p-5 rounded10 b-1 overflow-hidden">
								<input class="form-control b-0 py-10" type="text" placeholder="Say something..." id="msg">
								<div class="d-flex justify-content-between align-items-center mt-md-0 mt-30">
									<button type="button" class="waves-effect waves-circle btn btn-circle btn-primary" id="sendBtn">
										<i class="mdi mdi-send"></i>
									</button>
								</div>
							</div>
					  </div>
					</div>
				</div>
				<div class="col-xxxl-4 col-lg-5 col-12">
					  
					<div class="">
						<div class="box-header with-border">
						  <h4 class="box-title">상담 학생 인적 사항</h4>
						</div>
						<!-- /.box-header -->
						<div class="box-body">
							<div class="table-responsive">
							  <table class="table table-hover mb-0">
								  <tbody>
									<tr>
									  <th scope="col">이름</th>
					 				  <td>찌이짱</td>
									</tr>
								  </tbody>
								  <tbody>
									<tr>
									  <th scope="row">전공</th>
								 	  <td>컴공</td>
									</tr>
									<tr>
									  <th scope="row">학년</th>
								 	  <td>4학년</td>
									</tr>
									<tr>
									  <th scope="row">주소</th>
									  <td colspan="2">울산광역시 ㅁㄴㅇㄻㄴㄹㅇㅁ</td>
									</tr>
									<tr>
										 <th scope="row">기타 사항</th>
									 	 <td>으갸갸갸갸갸갹갸갸갸갸갸갸갸갸갸갸갸</td>
									</tr>
								  </tbody>
								</table>
							</div>
						</div>
						<!-- /.box-body -->
					  </div>
	
				</div>
			</div>

		</div>
	</div>
</section>
<button onclick="f_test()">test</button>
		<!-- /.content -->
</div>
<script src="${pageContext.request.contextPath}/resources/js/chat.js"></script>
<script>

var cnt = 0;

function f_test() {
	console.log($(".slimScrollBar"));
	
	
}
$(function () {
	contentScroll();

	var contextPath = "${pageContext.request.contextPath }";
	
/* 	var sendBtn = $("#sendBtn");
	var userId = "${userId }";
	var roomNo = "${roomNo }";
	var chatContent = $("#chatContent");
	var uploadFile = $("#file") */
	
	
	var sendBtn = $("#sendBtn");
	var chatContent = $("#chatContent");
	
	
	var memNo = 1;	/* ${member.memNo } */
	var chatRoomNo = 501;
	
	
	var memName = "김고양"; /* "${member.memName }"; */
	
	var sock = new SockJS("/counsel");

	sock.onopen = function(){
		console.log("연결완료");
		
		var chatMsg = memName + "님이 입장하셨습니다.";
		
		data = {
				"memNo" : memNo,
				"chatRoomNo" : chatRoomNo,
				"chatSender" : memName,
				"chatMsg" : chatMsg
		}
		
		sock.send(JSON.stringify(data));
		
	}

	sock.onmessage = function(res){
		data = JSON.parse(res.data);
		//console.log(data);
		
		code = "";
		
		if(memNo != data.memNo){
			code +=                                                                                                          
				'<div class="card d-inline-block mb-3 float-start me-2 no-shadow bg-lighter max-w-p80">                   '
				+'<div class="position-absolute pt-1 pe-2 r-0">                                                            '
				+'	<span class="text-extra-small text-muted">'+ dateFormat(new Date) + '</span>                          '
				+'</div>                                                                                                   '
				+'<div class="card-body">                                                                                  '
				+'	<div class="d-flex flex-row pb-2">                                                                     '
				+'		<div class="d-flex flex-grow-1 min-width-zero">                                                    '
				+'			<div class="m-2 ps-0 align-self-center d-flex flex-column flex-lg-row justify-content-between">'
				+'				<div class="min-width-zero">                                                               '
				+'					<p class="mb-0 fs-16 text-dark">'+ data.chatSender +'</p>                            '
				+'				</div>                                                                                     '
				+'			</div>                                                                                         '
				+'		</div>                                                                                             '
				+'	</div>                                                                                                 '
				+'	<div class="chat-text-start ps-55">                                                                    '
				+'		<p class="mb-0 text-semi-muted">'+ data.chatMsg +'</p>     '
				+'	</div>                                                                                                 '
				+'</div>                                                                                                   '
			  	+'</div>                                                                                                   '
			  	+'<div class="clearfix"></div>                                                                              '
		
		} else {
			code +=
				'<div class="card d-inline-block mb-3 float-end me-2 bg-primary max-w-p80">                                    '
				+'	<div class="position-absolute pt-1 pe-2 r-0">                                                               '
				+'		<span class="text-extra-small">'+ dateFormat(new Date) + '</span>                                     '
				+'	</div>                                                                                                      '
				+'	<div class="card-body">                                                                                     '
				+'		<div class="d-flex flex-row pb-2">                                                                      '
				+'			<div class="d-flex flex-grow-1 min-width-zero">                                                     '
				+'				<div class="m-2 ps-0 align-self-center d-flex flex-column flex-lg-row justify-content-between"> '
				+'					<div class="min-width-zero">                                                                '
				+'						<p class="mb-0 fs-16">'+ data.chatSender +'</p>                                        '
				+'					</div>                                                                                      '
				+'				</div>                                                                                          '
				+'			</div>                                                                                              '
				+'		</div>                                                                                                  '
				+'		<div class="chat-text-start ps-55">                                                                     '
				+'			<p class="mb-0 text-semi-muted">'+ data.chatMsg +'</p>                               '
				+'		</div>                                                                                                  '
				+'	</div>                                                                                                      '
				+'  </div>                                                                                                      '
		}
		
	  	chatContent.append(code);

	}

	sock.onclose = function(){
		console.log("연결 종료");
		
	}
	
	//메시지 전송
	sendBtn.on("click", function () {
		
		var msg = $("#msg").val();
		if(msg == null || msg == ""){
			return false;
		}
		
		$("#msg").val("");
		
		console.log(userId, roomNo, msg);
		data = {
				"userId" : userId,
				"roomNo" : roomNo,
				"chatMsg" : msg
		}
		sock.send(JSON.stringify(data));
	})
	
	$("#msg").keypress(function (e) {
        if (e.keyCode === 13) {
        	sendBtn.trigger("click");
        }
    });
	
})


function contentScroll() {
	chatUl = $(".slimScrollBar");
	chatUl.scrollTop = chatUl.scrollHeight;
}
</script>



	

	
	

