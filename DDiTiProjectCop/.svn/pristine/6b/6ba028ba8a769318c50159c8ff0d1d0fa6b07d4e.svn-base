<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!-- Content Header (Page header) -->

<div class="content-header">
	<div class="d-flex align-items-center">
		<div class="me-auto">
			<h3 class="page-title">${myClassVO.className }</h3>
			<div class="d-inline-block align-items-center">
				<nav>
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="#">
								<i class="mdi mdi-home-outline"></i></a></li>
						<li class="breadcrumb-item" aria-current="page">강의</li>
						<li class="breadcrumb-item active" aria-current="page">수강</li>
					</ol>
				</nav>
			</div>
		</div>
	</div>
</div>
<div class="row m-10 bg-white">
	<div class="row col-md-3">
		<div class="form-group">
			<strong>대학</strong>
			<div class="b-1 border-dark rounded p-1 ps-2">
				<c:if test="${myClassVO.dprtCategory eq 'DPC001'}">인문</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC002'}">사회</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC003'}">교육</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC004'}">공학</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC005'}">자연</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC006'}">의약</c:if>
				<c:if test="${myClassVO.dprtCategory eq 'DPC007'}">예체능</c:if>
			</div>
		</div>
	</div>
	<div class="row col-md-3">
		<div class="form-group">
			<strong>학과</strong>
			<div class="b-1 border-dark rounded p-1 ps-2">${myClassVO.dprtName }</div>
		</div>
	</div>
	<div class="row col-md-4">
		<div class="form-group">
			<strong>강의명</strong>
			<div class="b-1 border-dark rounded p-1 ps-2">${myClassVO.className }</div>
		</div>
	</div>
	<div class="row col-md-2">
		<div class="form-group">
			<strong>수강인원</strong>
			<div class="b-1 border-dark rounded p-1 ps-2">??/25</div>
		</div>
	</div>
</div>
<ul class="nav nav-tabs" role="tablist">
	<li class="nav-item">
		<a class="nav-link active" data-bs-toggle="tab" href="#examAnswer" role="tab" aria-selected="true">
			<span class="hidden-sm-up"><i class="fa fa-paypal"></i></span>
			<span class="hidden-xs-down">시험 응시 목록</span>
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link" data-bs-toggle="tab" href="#examplCreate" role="tab" aria-selected="false">
			<span class="hidden-sm-up"><i class="fa fa-paypal"></i></span>
			<span class="hidden-xs-down">시험 출제</span>
		</a>
	</li>
</ul>

<div class="tab-content tabcontent-border m-15 bg-white">
	<div class="tab-pane active" id="examAnswer" role="tabpanel">
		<div class="box-body">
			<div class="col-12">
				<h3 class="mt-30 ms-30"><strong>시험 응시자 목록</strong></h3>
			</div>
			<div class="row col-12 justify-content-end">
				<div class="row col-4 text-end">
					<!-- homeworkList -->
					<select class="form-control" id="exSelect">
						<option value="">===선택===</option>
						
						<c:if test="${!empty exampleList }">
							<c:forEach items="${exampleList }" var="ex">
								<option value="${ex.examNo }">${ex.examName }</option>
							</c:forEach>
						</c:if>
					</select>
				</div>
				<!-- <div class="col-3 text-end">
					<button class="waves-effect waves-light btn bg-info me-30" 
						id="hwScoreSubmitBtn">과제 점수 등록</button>
				</div> -->
			</div>
			<div class="table-responsive m-30">
				<table class="table">
					<thead class="bg-primary">
						<tr>
							<th>학번</th>
							<th>이름</th>
							<th width="30%">시험</th>
							<th>제출일</th>
							<th class="text-center">답안 보기</th>
							<th class="text-center">점수</th>
						</tr>
					</thead>
					<tbody id="exSubList">
						<tr>
							<td colspan="6">조회하실 게시물이 존재하지 않습니다.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div class="tab-pane" id="examplCreate" role="tabpanel">
		<div class="box-header">
			<div class="row col-12 justify-content-end">
				<div class="col-7">
					<h3 class="mt-15 ms-30"><strong>시험 출제</strong></h3>
				</div>
				<div class="col-5 text-end">
					<button class="waves-effect waves-light btn bg-success me-30 mt-7" 
						id="examExcelDownloadBtn">시험 출제 폼 다운로드</button>
					<button class="waves-effect waves-light btn bg-success me-30 mt-7" 
						id="examExcelUploadBtn">시험 업로드</button>
					<button class="waves-effect waves-light btn bg-success me-30 mt-7" 
						id="examCreateBtn">시험 등록</button>
						
				</div>
			</div>
		</div>
		<div class="box-body row" style="min-height: 470px">
			<div class="col-2" style="border: 1px solid">
				총점	: <input type="number" id="" min="0" value="0" >
				<hr>
				<ul class="p-0" id="Qst">
					<li class="row Qst">
						<div class="col-1">
							<span class="box-title" style="">1.</span>
						</div>
						<div class="col-9">	
							<button class="btn btn-secondary btn-sm">Info Message </button>
						</div>
						<div class="col-2 position-relative">	
							<button type="button" class="btn-close position-absolute top-50 start-50 translate-middle" title="삭제"></button>
						</div>
					</li>
					
				</ul>
			</div>
			<div class="col-5" style="border: 1px solid">
				<h4 class="m-2">문제 :    </h4><input type="text" class="form-control" id="examQst">
				<h4 class="m-2">보기 이미지  </h4><input type="file" class="form-control" id="examImg">
					<input type="hidden" id="examImgFileNo" value="">
					<input type="hidden" id="examQstNo" value="0">
				<h4 class="m-2">정답 :    </h4><input type="number" min="1" max="10" value="1" class="form-control" id="qstCorrect">
				<h4 class="m-2">배점 :    </h4><input type="number" min="1" max="100" value="5" class="form-control" id="qstScore">
				<div class="text-end">
					<button class="btn btn-danger-light mt-5" id="resetQstBtn">초기화</button>
					<button class="btn btn-success-light mt-5" id="addQstBtn">문제 추가하기</button>
					<hr>
				</div>
			</div>
			<div class="col-5" style="border: 1px solid">
				<div class="text-end m-10">
					<button class="btn btn-danger-light" id="resetChoiceBtn">초기화</button>
					<button class="btn btn-success-light" id="addChoiceBtn">보기 추가하기</button>
				</div>
				
				<ul class="p-0" id="qchoice">
				
					<li class="row choice">
						<div class="col-1">
							<span class="box-title" >1.</span>
						</div>
						<div class="col-10">	
							<input class="form-control choiceStr">
						</div>
						<div class="col-1 position-relative">	
							<!-- <button type="button" class="btn-close position-absolute top-50 start-50 translate-middle" title="삭제"></button> -->
						</div>
					</li>
					<li class="row choice">
						<div class="col-1">
							<span class="box-title" >2.</span>
						</div>
						<div class="col-10">	
							<input class="form-control choiceStr">
						</div>
						<div class="col-1 position-relative">	
							<!-- <button type="button" class="btn-close position-absolute top-50 start-50 translate-middle" title="삭제"></button> -->
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>

<script>
	
	var examQuestion = [];						// 문제 목록 정보
	var addQstBtn = $("#addQstBtn");			// 문제 추가
	var resetQstBtn = $("#resetQstBtn");		// 문제 초기화
	
	//var examQstNo = $("#examQstNo"); 			//문제 목록 번호
	
	var examQst = $("#examQst");				// 문제
	var examImg = $("#examImg");				// 파일
	var examImgFileNo = $("#examImgFileNo");	// 파일 번호
	var qstCorrect = $("#qstCorrect");			// 정답 번호
	var qstScore = $("#qstScore");				// 배점 
	
	var qchoice = $("#qchoice");				// 보기 목록
	var addChoiceBtn = $("#addChoiceBtn");		// 보기 추가
	var resetChoiceBtn = $("#resetChoiceBtn");	//	보기 초기화
	
	var examCreateBtn = $("#examCreateBtn");	// 시험 등록 버튼
	
	qstScore.on("change", function () {
		try{
			parseInt(this.value);
		} catch (e) {
			this.value = 1;
		}
		
		if(this.value < 1){
			this.value = 1;
		}
		
		if(this.value > 100){
			this.value = 100;
		}
	})
	
	qstCorrect.on("change", function () {
		console.log("changes...", this.value);
		
		try{
			parseInt(this.value);
		} catch (e) {
			alert("정확한 값을 입력해주세요");
			this.value = 1;
		}
		
		if(this.value < 1){
			this.value = 1;
		}
		
		var chl = qchoice.find("li").length;
		if(this.value > chl){
			this.value = chl;
		}
	})
	
	addQstBtn.on("click", function () {
		console.log("addQst");
		
		var qstChoice = qchoice.find(".choiceStr");
		var chStr = [];
		
		console.log(qstChoice);
		
		for (var i = 0; i < qstChoice.length; i++) {
			chStr.push($(qstChoice[i]).val());
		}
		
		console.log("chStr : ",chStr);
		
		var qstData = {
				'examQst' : examQst.val(),
				'examImg' : examImg.val(),
				'qstCorrect' : qstCorrect.val(),
				'qstScore' : qstScore.val(),
				'fileNo' : examImgFileNo.val(),
				'chStr' : chStr
		}

		examQuestion.push(qstData);
		
		//제출 폼 초기화
		resetQstBtn.trigger("click");
		resetChoiceBtn.trigger("click");
		
		// 문제 목록 추가 
		
	})
	
	
	//보기 삭제 버튼
	$(document).on("click", ".chDelBtn", function () {
		console.log("del");
		$(this).parents("li").remove();
		
		var chl = qchoice.find("li");
		
		//보기 번호 재설정
		for (var i = 2; i < chl.length; i++) {
			$(chl[i]).find(".box-title").text( (i + 1) + ".");
		}
	})
	
	//보기 추가
	addChoiceBtn.on("click", function (){
		var chNo = qchoice.find("li").length + 1;
		
		if(chNo > 10){
			alert("보기는 최대 10개입니다.");
			return false;
		}
		
		var code = ''
			+'<li class="row choice">                     '
			+'<div class="col-1">                         '
			+'	<span class="box-title" >' +chNo+'.</span>'
			+'</div>                                      '
			+'<div class="col-10">	                      '
			+'	<input class="form-control choiceStr">    '
			+'</div>                                      '
			+'<div class="col-1 position-relative">	      '
			+'<button type="button" class="btn-close position-absolute top-50 start-50 translate-middle chDelBtn" title="삭제"></button>'
			+'</div>                                      '
			+'</li>                                       '
			qchoice.append(code);
	})
	
	//설정중인 보기 초기화
	resetChoiceBtn.on("click", function (){
		var code = ''
			+'<li class="row choice">                     '
			+'<div class="col-1">                         '
			+'	<span class="box-title" >1.</span>        '
			+'</div>                                      '
			+'<div class="col-10">	                      '
			+'	<input class="form-control choiceStr">    '
			+'</div>                                      '
			+'<div class="col-1 position-relative">	      '
			+'</div>                                      '
			+'</li>                                       '
			+'<li class="row choice">                     '
			+'<div class="col-1">                         '
			+'	<span class="box-title" >2.</span>        '
			+'</div>                                      '
			+'<div class="col-10">	                      '
			+'	<input class="form-control choiceStr">    '
			+'</div>                                      '
			+'<div class="col-1 position-relative">	      '
			+'</div>                                      '
			+'</li>                                       '
		
		$("#qchoice").html(code);
	})
	
	//설정중인 문제 초기화
	resetQstBtn.on("click", function () {
		examQst.val("");
		examImg.val("");
		examImgFileNo.val("");
		qstCorrect.val("");
		qstScore.val("");
	})
	
	var fileData;
	examImg.on("change", function (event) {
		console.log("file name : " + $(this).val());
		
		var file = event.target.files[0];
		
		//사진여부 확인
		if(!isImageFile(file)){
			console.log("not img file...");
			alert("사진만 등록 가능합니다.");
			examImg.val("");
			return false;
		}
		
		addQstBtn.attr("disabled", true);
		
		var formData = new FormData();
		formData.append("files", file);
		
		$.ajax({
			url : "/DYUniv/examFileUpload.ajax",
			type : "post",
			data : formData,
			processData : false,
			contentType : false,
			success : function(res){
				if(res > 0){
					console.log("file upload success. res : "+ res);
					examImgFileNo.val(res);
				} else {
					alert("파일 업로드 실패...")
				}
				addQstBtn.removeAttr("disabled");
			},
			error : function(request,status,error){        
				alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);  
				addQstBtn.removeAttr("disabled");
			}
		})
	})

	examCreateBtn.on("change", function(){
		
	});
	
	$(function () {

		var exSelect = $("#exSelect");
		var exSubList = $("#exSubList");
		
		var exPopup = "";
		
 		$(document).on("click", ".examDetailBtn", function () {
 			console.log("detailBtn click..");
 					
			var memInfoRow = $(this).parent().parent();
			
 			console.log("memNo : ", memInfoRow.find(".memName").attr("idx"));
 			console.log("memName : ", memInfoRow.find(".memName").text());
 			console.log("examNo : ", $(this).attr("idt"));
 			
 			//체점 페이지
 			
		})
		
		//과제 선택
		exSelect.on("change", function () {
			var examNo = $(this).val();
			
			if(examNo == null || examNo == ""){
				return false;
			}
			
			var data = {
					"examNo" : examNo
			}
			
			exSubList.html(
				'<tr>'
					+ '<td colspan="6">조회하실 게시물이 존재하지 않습니다.</td>'
				+ '</tr>'
			);

			$.ajax({
				type: 'post',
				url: '/DYUniv/class/exSubmitList',
				data : data,
				success: function (res) { /* 결과 성공 콜백함수 */
					console.log(res);
				
					code = '';

					if(res != null && res.length > 0){
						$.each(res, function(i,v)  {
							
							var fileNo = "0";
							var fileName = "(제출 파일 없음)";
							
							if(v.fileNo != 0){
								fileNo = v.fileNo;
								fileName = v.fileName;
							}
							
							code += '<tr class="exMemList">';
							code += '	<td class="">' + v.memId + '</td>';
							code += '	<td class="memName" idx="'+ v.memNo +'">' + v.memName + '</td>';
							code += '	<td>' + v.examName + '</td>';
							code += '	<td>' + v.answerDate.substr(0,10) + '</td>';
							code += '	<td class="text-center"><button class="btn btn-primary-light btn-xs examDetailBtn" idt="' + v.examNo + '">시험지 체점하기</button></td>';
							code += '	<td class="exScore text-end" idx="'+ v.examNo +'"><input type="number" value="'+ v.totalScore +'" readonly> </td>';
							code += '</tr>';
						});
					} 
					//console.log(code);
					exSubList.html(code);
				}
			})
		})
		
	})
	

	/* 파일 다운로드*/
	function hwFileDownload(el) {
		//console.log($(el).attr("idx"));
		//console.log($(el).attr("idn"));

		var fileNo = $(el).attr("idx");
		var fileName = $(el).attr("idn");

		fileDownload(fileNo, fileName);
	}
	
	function isImageFile(file) {
		var ext = file.name.split(".").pop().toLowerCase();		//파일명의 확장자를 가져온다
		//확장자중 이미지에 해당하는 확장자가 아닌경우 -1 리턴 (false)
		return ($.inArray(ext, ["jpg", "jpeg", "gif", "png"]) === -1) ? false : true
	}
</script>