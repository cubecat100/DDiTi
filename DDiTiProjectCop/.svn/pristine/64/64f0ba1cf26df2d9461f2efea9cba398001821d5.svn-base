/**
 * 
 */
 
 
const gridBtn = document.querySelector("#gridBtn");
const gridBtnSpan = document.querySelector("#gridBtnSpan");
const gridMenu = document.querySelector("#gridMenu");

let clickFlag = true;

var todoContentList;
var toDoList;

function f_gridMenu() {
	console.log(clickFlag)
	
	if (clickFlag) {
		console.log("화면 구성 설정 화면")
		gridBtnSpan.innerHTML = "화면 구성 완료";
		gridMenu.style.display = "block";
		
		//grid.noMove = false;
		//grid.noResize = false;
		//grid.locked = false;
		
		//gridOption.disableDrag = false;
		//grid = GridStack.init(gridOption);
		
		grid.disableResize = false;
		
		loadGrid(items);
	} else {
		console.log("화면 구성 완료 화면")
		gridBtnSpan.innerHTML = "화면 구성 설정";
		gridMenu.style.display = "none";
		
		//grid.noMove = true;
		//grid.noResize = true;
		//grid.locked = true;
		
		//gridOption.disableDrag = true;
		//grid = GridStack.init(gridOption);
		
		loadGrid(items);
	}
	clickFlag = !clickFlag;
	console.log(gridOption)
};

function f_memoMenu() {
	const memoBtn = document.querySelector("#memoBtn");
	const inputText = document.querySelector("#inputText");
	const inputTA = document.querySelector("#inputTA");
	
	if (clickFlag) {
		memoBtn.innerHTML = "수정";
		inputText.readOnly = true;
		inputTA.readOnly = true; 
	} else {
		memoBtn.innerHTML = "완료";
		inputText.readOnly = false;
		inputTA.readOnly = false; 
	}
	clickFlag = !clickFlag;
};

function f_todoModify() {
	const todoModify = document.querySelector("#todoModify");
	const todoText = document.querySelector("#todoText");
	
	if (clickFlag) {
		todoModify.innerHTML = "수정";
		todoText.readOnly = true;
	} else {
		todoModify.innerHTML = "완료";
		todoText.readOnly = false;
	}
	clickFlag = !clickFlag;
}

/* 위젯 시작 */

// 학사일정
academicCal = `
	<div class="box">
		<div class="box-header with-border">
			<h4 class="box-title">학사일정</h4>
			<div class="box-controls pull-right d-md-flex d-none">
				<a href="">더보기</a>
			</div>
		</div>
		<div class="box-body">
			<div class="table-responsive">
				<table class="table mb-0 b-1 border-primary"
					style="text-align: center">
					<thead class="bg-primary">
						<tr>
							<th scope="col">제목</th>
							<th scope="col" style="width:40%;">내용</th>
							<th scope="col" style="width:35%;">기간</th>
						</tr>
					</thead>
					<tbody id='uniScheduleBox'></tbody>
				</table>
			</div>
		</div>
	</div>
`;

// TODO
todo = `
	<div class="box">
		<div class="box-header with-border">
			<h4 class="box-title">Todo</h4>
			<div class="box-controls pull-right d-md-flex d-none">
				<button class="btn btn-primary px-10" href="#"
					style="font-size: 11px" data-bs-toggle="modal"
						data-bs-target="#createTodo">추가하기</button>
			</div>
		</div>
		<div class="box-body slimScrollDiv" id="todoListBox"></div>
	</div>
`;

// 공지사항
noticeBoard = `
		<div class="box">
			<div class="box-header with-border">
				<h4 class="box-title">공지사항</h4>
				<div class="box-controls pull-right d-md-flex d-none">
					<a href="/DYUniv/noticeBoard.do">더보기</a>
				</div>
			</div>
			<div class="box-body">
				<div class="table-responsive">
					<table class="table mb-0 b-1 border-primary"
						style="text-align: center">
						<thead class="bg-primary">
							<tr>
								<th scope="col">제목</th>
								<th scope="col">내용</th>
								<th scope="col">게시일</th>
							</tr>
						</thead>
						<tbody id="noticeWidgetBox">
							<!-- 공지사항 게시물 아작스 -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
`;

// 시간표
classBoard = `
	<div class="box">
		<div class="box-header with-border">
			<h4 class="box-title">오늘 시간표</h4>
			<div class="box-controls pull-right d-md-flex d-none">
				<a href="">더보기</a>
			</div>
		</div>

		<div class="box-body">
			<p class="mb-5">
				<span id="td_year">2023</span>년 <span id="td_month">01</span>월 <span
					id="td_date">05</span>일
			</p>
			<div id="classBox">
				<!-- 수업 박스 1개 시작 -->
				<div class="box mb-15 pull-up boar bg-primary-light">
					<div>
						<div class="table-responsive">
							<table class="table no-border mb-0">
								<tbody>
									<tr>
										<td class="fw-600 min-w-130">
											<div class="d-flex flex-column fw-600">
												<a href="#" class="text-dark hover-primary mb-1 fs-16">1교시
													- 3교시</a> <span class="text-fade">IT대학 A동 102호</span>
											</div>
										</td>
										<td class="fw-600 fs-16 min-w-200 text-center">
											<i class="fa fa-fw fa-circle text-primary fs-12" style="display:inline-block;"></i>
											<span>알고리즘의 이해</span>
										</td>
										<td class="fw-400 fs-16 min-w-150 text-center">홍길동 교수</td>
										<td class="text-primary fw-600 fs-16 min-w-150 text-end">
											<a href="#"> <span>Class room > </span> </a>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<!-- 수업 박스 1개 끝 -->
			</div>
		</div>
	</div>
`;

// 메모
memo = `
	<div class="box box-outline-warning" style="width:100%; height:100%">
	  <div class="box-header">
		<h4 class="box-title" style="width:100%"><strong><input type="text" class="no-border row" style="width:80%" id="inputText"></strong></h4>
		<div class="box-tools flex-end">					
			<div class="box-controls">
			  <button class="btn btn-rounded btn-secondary btn-sm btn-outline btn-primary" id="memoBtn" onclick="f_memoMenu()">수정</button>
			</div>
		</div>
	  </div>

	  <div class="box-body">
		<div class="form-group">
			<textarea class="form-control no-border" id="inputTA"></textarea>
		</div>
	  </div>
	</div>
`;

/* 위젯 끝 */
	
	
	
/* 포틀릿 시작 */

let gridOption = {
    column: 12,                   // default 12 -> 6
    oneColumnSize: 100,          // default 768 -> 100
    minRow: 1,
    // disableOneColumnMode: true,
    margin: 10,
    disableResize: true,
    disableDrag: false,
    removable: 'body',
    removable: true,
    resizable: { handles: 'e,se,s,sw,w' },
}

function loadGrid(widget){
	
	grid.load(widget);
	let gridList = document.querySelectorAll('.grid-stack-item');
    
    for(let i=0; i<gridList.length; i++){
	    let menu = gridList[i].getAttribute('gs-id');
	    let menuName;
	    switch (menu) {
	        case 'academicCal': menuName = '학사일정'; break;
	        case 'todo': menuName = '할일목록'; break;
	        case 'noticeBoard': menuName = '공지사항'; break;
	        case 'classBoard': menuName = '수강시간표'; break;
	        case 'memo': menuName = '메모'; break;
    	}
	}
	
	grid.on('added removed change', function(e, items) {
		let str = '';
		items.forEach(function(item) {
			 str += ' (x,y)=' + item.x + ',' + item.y;
		});
		
		console.log(e.type + ' ' + items.length + ' items:' + str );
    });
    
	univScheduleWidget();
	noticeWidget();
	f_listTodo();
}

// 알아서 정리 메뉴
function fcompact() {
    grid.compact();
}
// 요소 더하기 메뉴 (메모 위젯만 추가)
function f_addObj(){
    var grid_x = document.querySelector("#grid_x").value;
    var grid_y = document.querySelector("#grid_y").value;

    grid.addWidget({ w: grid_x*2, h: grid_y*2, id:'memo', content: memo });
}
// 포지션 저장 메뉴
function f_postionSave(){
    console.log("position save...");
    var items = [];

    var itemList = grid.engine.nodes;
    
    console.log("포지션 저장메뉴 itemList", itemList);

    for(var i=0; i<itemList.length; i++){
        var item = {};
        
        item.memNo = memNo;
        item.x = itemList[i].x;
        item.y = itemList[i].y;
        item.w = itemList[i].w;
        item.h = itemList[i].h;

        if(itemList[i].id === 'classBoard'){
	    	item.widType = 'WID001';
			item.content = null;
	    } else if(itemList[i].id === 'todo'){
	    	item.widType = 'WID002';
			item.content = JSON.stringify(toDoList);
	    } else if(itemList[i].id === 'academicCal'){
	    	item.widType = 'WID003';
			item.content = null;
	    } else if(itemList[i].id === 'noticeBoard'){
	    	item.widType = 'WID004';
			item.content = null;
	    } else if(itemList[i].id === 'memo'){
	    	item.widType = 'WID005';
	    } 

        items.push(item);
    }
    console.log("저장할 new 데이터", items);

	$.ajax({
		type: "post",
		url: "/DYUniv/mainpage.do/updateWidget",
		contentType: "application/json",
	    data: JSON.stringify(items),
	    dataType: 'json',
		success: function (result) {
		  console.log("update position check : ", result);
		  if (result == 1) {
			alert("포지션 수정 완료 !");
		  }
		},
	  });

    //스트링 형태로 저장
    // localStorage.setItem("items", JSON.stringify(items));
}
// 모든 요소 삭제 메뉴
function f_removeAll(){
    grid.removeAll();
}
// 포지션 불러오기 메뉴
function f_postionLoad(){
	var items = [];

	$.ajax({
		type : "get",
		url : "/DYUniv/mainpage.do/widgetList",
		data : {memNo:memNo},       // get 방식인 경우 jQuery가 알아서 "/mainpage.do/widgetList?memNo=4" 맹글어 줌
		dataType : "json",
		success : function(result){
			console.log("result", result);
		
			for (var i = 0; i < result.length; i++) {

			    var item = {
			        x: result[i].x,
			        y: result[i].y,
			        w: result[i].w,
			        h: result[i].h,
			        id: '',
			        content: null,
					label: null
			    };
		
			    if (result[i].widType === 'WID001') {
			        item.id = 'classBoard';
			        item.content = classBoard;
			    } else if (result[i].widType === 'WID002') {
			        item.id = 'todo';
			        item.content = todo;
			        item.label = result[i].label;
			    } else if (result[i].widType === 'WID003') {
			        item.id = 'academicCal';
			        item.content = academicCal;
			    } else if (result[i].widType === 'WID004') {
			        item.id = 'noticeBoard';
			        item.content = noticeBoard;
			    } else if (result[i].widType === 'WID005') {
			        item.id = 'memo';
			        item.content = memo;
			    }
			
			    items.push(item);
			}
		    //스트링 변환
		    // var items = JSON.parse(localStorage.getItem("items"));
		    
		    console.log("items", items);
		
		    if(items == null || items == ""){
		        console.log("position empty...")
		        return;
		    }
			
		    f_removeAll();
		    console.log("reloadItems : ", items);
		    grid.load(items);
		    loadGrid(items);
		}	// success end
	});
}
// 선택 메뉴 생성
function f_selectwidget(){
	var selectMenu = $("#selectMenu").val();
	var selectData = {
		memNo : memNo,
		widType : selectMenu
	};

    $.ajax({
    	type: "post",
		url: "/DYUniv/mainpage.do/selectWidget",
		contentType: "application/json",
	    data: JSON.stringify(selectData),
	    dataType: 'json',
		success: function (result) {
		  
		if(result.widType === 'WID001'){
	    	result.id = 'classBoard';
	    	result.content = classBoard;
	    } else if(result.widType === 'WID002'){
	    	result.id = 'todo';
			result.label = result.content;
	    	result.content = todo;
	    } else if(result.widType === 'WID003'){
	    	result.id = 'academicCal';
	    	result.content = academicCal;
	    } else if(result.widType === 'WID004'){
	    	result.id = 'noticeBoard';
	    	result.content = noticeBoard;
	    } else if(result.widType === 'WID005'){
	    	result.id = 'memo';
	    	result.content = memo;
	    } 
		  
		  grid.addWidget(result);
		  univScheduleWidget();
		  noticeWidget();
		}
    	
    });

    
}

/* 포틀릿 끝 */


/* 학사일정 아작스 시작 */

function univScheduleWidget(){
	$.ajax({
		type : "get",
		url : "/DYUniv/mainpage.do/univSchedule",
		dataType : "json",
		success : function(result){
			let html = "";
			
			console.log("success check : ", result);
			
	        for (let i = 0; i < result.length; i++) {
	          	let rs = result[i];
	          	
	          	html += '<tr><td>' + rs.univSchName +'</td>';
	          	html += '<td>' + rs.univSchCont + '</td>';
	          	html += '<td><span>' + rs.univSchStartDate.slice(0, 10) + '</span> ~ <span>' + rs.univSchEndDate.slice(0, 10) + '</span></td></tr>';
	        }
	        
	       $("#uniScheduleBox").html(html);
		},
		error: function (request, status, error) {
	       console.log("code: " + request.status)
	       console.log("message: " + request.responseText)
	       console.log("error: " + error);
		}
	});
}


/* 학사일정 아작스 끝 */
	
	
/* 공지사항 아작스 시작 */

function noticeWidget(){
	$.ajax({
		type : "get",
		url : "/DYUniv/mainpage.do/notice",
		dataType : "json",
		success : function(result){
			let html = "";
			
			console.log("success check : ", result);
			
	        for (let i = 0; i < result.length; i++) {
	          	let rs = result[i];
	          	
	          	html += '<tr><td><a href="/DYUniv/academicPlan/detail?brdNo='+ rs.brdNo +'">' + rs.brdTitle +'</a></td>'
	          	html += '<td>' + rs.brdCont + '</td>'
	          	html += '<td>' + rs.writeDate.slice(0, 10) + '</td></tr>';
	        } 
	        
	       $("#noticeWidgetBox").html(html);
		},
		error: function (request, status, error) {
		       console.log("code: " + request.status)
		       console.log("message: " + request.responseText)
		       console.log("error: " + error);
		}
	});
}

/* 공지사항 아작스 끝 */


/* todo 시작 */
function f_listTodo(){
	console.log("toDoList", toDoList);
	
	html = "";
	index = 20;
	for(var i = 0; i < toDoList.length; i++){
		index += i;
		todoItem = toDoList[i];
		console.log("todoItem", todoItem);
		html 
			+= '<div class="d-flex align-items-center mb-25 todoBox"><span class="bullet bullet-bar bg-primary align-self-stretch"></span>'
			+'<div class="h-20 mx-20 flex-shrink-0"><input type="checkbox" id="md_checkbox_'
			+ index
			+'" class="filled-in chk-col-primary"/>'
			+'<label for="md_checkbox_'
			+ index
			+'" class="h-20 p-10 mb-0"></label></div><div class="d-flex flex-column flex-grow-1">'
			+'<a class="text-dark hover-primary fw-500 fs-16" data-bs-toggle="modal" data-bs-target="#detailTodo" onclick="fYWchk(this)" style="cursor: pointer;" id="yw'
			+ i
			+'">' 
			+ todoItem.text
			+ '</a><span class="text-fade fw-500" id="todoDate">'
			+ todoItem.date
			+ '</span></div></div>';

		$("#todoListBox").html(html);
	}
}
// 실패 ㅜㅜ
function f_listTodo2(){
	console.log("items", items);
	console.log("todoContent", todoContent);
	
	todoContentList = todoContent.split("/&&/");
	console.log("todoContentList", todoContentList);

	html = "";
	index = 20;
	for(var i = 0; i < todoContentList.length; i++){
		index = 20 + i;
		todoItem = todoContentList[i].split("/&/");
		console.log("todoItem", todoItem);
		html 
			+= '<div class="d-flex align-items-center mb-25 todoBox"><span class="bullet bullet-bar bg-primary align-self-stretch"></span>'
			+'<div class="h-20 mx-20 flex-shrink-0"><input type="checkbox" id="md_checkbox_'
			+ index
			+'" class="filled-in chk-col-primary" />'
			+'<label for="md_checkbox_'
			+ index
			+'" class="h-20 p-10 mb-0"></label></div><div class="d-flex flex-column flex-grow-1">'
			+'<a class="text-dark hover-primary fw-500 fs-16" data-bs-toggle="modal" data-bs-target="#detailTodo" onclick="fYWchk(this)" style="cursor: pointer;" id="yw'
			+ i
			+'">' 
			+ todoItem[0]
			+ '</a><span class="text-fade fw-500" id="todoDate">'
			+ todoItem[1]
			+ '</span></div></div>';

		$("#todoListBox").html(html);
	}
}

// 모달의 "저장" 버튼 클릭 시
$("#saveTodoChanges").click(function () {
	// 수정된 값을 가져옴
	var modifiedText = $("#modTodoText").val();
	alert(modifiedText);

	//ywAtag.innerHTML = modifiedText;  //
	//console.log("체킁1:",ywAtag); 
	var ywIndex = ywAtag.id.replace("yw","");
	toDoList[ywIndex].text= modifiedText;
	console.log("체킁2:",toDoList);
	
	/* 수정된 값을 toDoList에 반영
	if (pThis.id >= 0 && pThis.id < toDoList.length) {
		toDoList[pThis.id] = modifiedText;
		console.log("Modified toDoList", toDoList);

		// 여기에 수정된 값을 저장하는 등의 추가 로직을 추가할 수 있음
	}
	*/

	// 모달 닫기
	$("#detailTodo").modal('hide');

	// 수정 후 목록 갱신
	f_listTodo();
});

// 수정화면
var ywAtag;  // 클릭한 a 태그 값을 담을 변수
function fYWchk(pThis){
	//alert(pThis.innerHTML);  예원이 모달 맹글어 써야 함!, 요렇게 하면 실력이 안 늘어용!, 가성비가 안 나와용!
	$("#modTodoText").val(pThis.innerHTML);
	ywAtag  = pThis;	
	console.log("i", pThis.id);
/*
	for(var i = 0; i < todoContentList.length; i++){
		if(pThis.id == i){
			console.log(todoContentList[i]);
			todoItem = todoContentList[i].split("/&/");
			console.log(todoItem[0]);
		}
	}
*/
}
// 요기를 쪼금 설계 개념이 보이도록
function f_createTodo(){

	newTodoText = $("#newTodoText").val();
	newTodoTime = new Date().toISOString().slice(0, 10); // yyyy-mm-dd
	
	console.log("newTodoText", newTodoText);

	var toDo = {}
	toDo.text = newTodoText;
	toDo.date = newTodoTime;

	toDoList.push(toDo);
	
	// textarea 비우기
	$("#newTodoText").val("");

	//모달창끄기
	$("#createTodo").modal('hide');
	
	f_listTodo();
}
/* todo 끝 */

/* 강의시간표 시작 */

function f_classBoardList(){

	$.ajax({
		type : "get",
		url : "/DYUniv/mainpage.do/classBoard",
		dataType : "json",
		success : function(result){
			let html = "";
			
			console.log("success check : ", result);
			/*
	        for (let i = 0; i < result.length; i++) {
	          	let rs = result[i];
	          	html +=
				'<div class="box mb-15 pull-up boar bg-primary-light">' +
				'<div> <div class="table-responsive"> <table class="table no-border mb-0">' +
				'<tbody> <tr> <td class="fw-600 min-w-130"> <div class="d-flex flex-column fw-600">' +
				'<a href="#" class="text-dark hover-primary mb-1 fs-16">' +
				'1교시 - 3교시' +
				'</a> <span class="text-fade">' +
				'IT대학 A동 102호'+
				'</span></div> </td> <td class="fw-600 fs-16 min-w-200 text-center">' +
				'<i class="fa fa-fw fa-circle text-primary fs-12" style="display:inline-block;"></i><span>'+
				'알고리즘의 이해'+
				'</span> </td> <td class="fw-400 fs-16 min-w-150 text-center">'+
				'홍길동'+ 
				' 교수</td><td class="text-primary fw-600 fs-16 min-w-150 text-end"> <a href="#"> <span>Class room > </span> </a>' +
				'</td> </tr> </tbody> </table> </div> </div> </div> ';
	        } 
	        
	       $("#classBox").html(html);*/
		},
		error: function (request, status, error) {
		       console.log("code: " + request.status)
		       console.log("message: " + request.responseText)
		       console.log("error: " + error);
		}
	});
}

/* 강의시간표 끝 */
